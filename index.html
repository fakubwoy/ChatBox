<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBox</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e0e0e0;  
            color: #1e1e1e;             
        }
        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 15px;
            background-color: #ccc;   
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress {
            height: 100%;
            background-color: #666;   
            transition: width 0.4s ease;
        }
        #chatBox {
            width: 95%;
            height: 400px;
            border: 1px solid #444;
            border-radius: 8px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e0e0e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        .message {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 10px;
            white-space: pre-wrap;  
        }
        .message.sent {
            align-items: flex-end;
        }
        .message.received {
            align-items: flex-start;
        }
        .message .username {
            font-weight: bold;
            margin-bottom: 5px;
            color: #444;  
        }
        .message .message-content {
            background-color: #414141;  
            color: #e0e0e0;             
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            white-space: pre-wrap;  
            overflow-wrap: break-word; 
        }
        #loginForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        #loginForm input, #loginForm button {
            margin: 5px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            outline: none;
        }
        #loginForm button {
            background-color: #444;
            color: #e0e0e0;
            border: none;
        }
        #loginForm button:hover {
            background-color: #333;
        }
        #mainContent {
            display: none;
            padding: 20px;
            background-color: #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            max-width: 800px; 
            margin: auto;
        }
        #messageInput {
            width: calc(100% - 90px); 
            height: 80px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            resize: none;
            box-sizing: border-box;
            margin-right: 10px;
            font-family: Arial, sans-serif;
            background-color: #fff; 
        }
        #sendButton {
            width: 80px;  
            height: 80px; 
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #444;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s, color 0.2s;
        }
        #sendButton:hover {
            background-color: #333;
            color: #fff;
        }
        .message-container {
            display: flex;
            align-items: flex-end;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="loginForm">
        <h2>Login</h2>
        <input type="text" id="serverIP" placeholder="Enter server IP">
        <input type="text" id="username" placeholder="Enter your username">
        <button onclick="login()">Connect</button>
    </div>

    <div id="mainContent">
        

        <h1>Chat</h1>
        <div id="chatBox"></div>
        <div class="message-container">
            <textarea id="messageInput" placeholder="Type your message" onkeydown="handleKeyDown(event)"></textarea>
            <button id="sendButton" onclick="sendMessage()">Send</button>
        </div>
        <h1>File Upload</h1>
        <input type="file" id="fileInput">
        <button onclick="uploadFile()">Upload</button>
        <div id="uploadProgress" class="progress-bar">
            <div id="uploadBar" class="progress"></div>
        </div>

        <h1>File Download</h1>
        <select id="fileSelect"></select>
        <button onclick="downloadFile()">Download</button>
        <div id="downloadProgress" class="progress-bar">
            <div id="downloadBar" class="progress"></div>
        </div>
    </div>

    <script>
        let API_URL = '';
        let username = '';
        let lastMessageId = -1;
        let eventSource;

        function login() {
            const serverIP = document.getElementById('serverIP').value.trim();
            username = document.getElementById('username').value.trim();

            if (!serverIP || !username) {
                alert('Please enter both server IP and username.');
                return;
            }

            API_URL = `http://${serverIP}:12345`;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            updateFileList();
            startChatConnection();
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const progressBar = document.getElementById('uploadProgress');
            const progressBarFill = document.getElementById('uploadBar');
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';

            try {
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    updateFileList();
                } else {
                    alert('File upload failed');
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            } finally {
                progressBar.style.display = 'none';
            }
        }

        async function updateFileList() {
            try {
                const response = await fetch(`${API_URL}/list-files`);
                if (response.ok) {
                    const data = await response.json();
                    const fileSelect = document.getElementById('fileSelect');
                    fileSelect.innerHTML = '';

                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file;
                        option.textContent = file;
                        fileSelect.appendChild(option);
                    });
                } else {
                    alert('Failed to retrieve file list');
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            }
        }

        async function downloadFile() {
            const fileSelect = document.getElementById('fileSelect');
            const fileName = fileSelect.value;
            if (!fileName) {
                alert('Please select a file.');
                return;
            }

            const progressBar = document.getElementById('downloadProgress');
            const progressBarFill = document.getElementById('downloadBar');
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';

            try {
                const response = await fetch(`${API_URL}/download/${encodeURIComponent(fileName)}`);
                if (response.ok) {
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = fileName;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="?(.+)"?/i);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('File download failed');
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            } finally {
                progressBar.style.display = 'none';
            }
        }

        function startChatConnection() {
            if (eventSource) {
                eventSource.close();
            }
            eventSource = new EventSource(`${API_URL}/chat?last_id=${lastMessageId}`);
            const chatBox = document.getElementById('chatBox');

            eventSource.onmessage = function(event) {
                if (event.data.trim() !== "") {  
                    const message = JSON.parse(event.data);
                    displayMessage(message);
                    lastMessageId = message.id;
                }
            };

            eventSource.onerror = function(error) {
                console.error('EventSource failed:', error);
                eventSource.close();
                setTimeout(startChatConnection, 5000);
            };
        }

        function displayMessage(message) {
            const chatBox = document.getElementById('chatBox');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.username === username ? 'sent' : 'received'}`;
            messageElement.innerHTML = `<span class="username">${message.username}</span><span class="message-content">${message.message}</span>`;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) {
                alert('Please enter a message.');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, message }),
                });

                if (response.ok) {
                    const result = await response.json();
                    messageInput.value = '';
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    return;
                } else {
                    event.preventDefault();
                    sendMessage();
                }
            }
        }
    </script>
</body>
</html>
